<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel Details with Accommodation Details</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .selected-option {
            display: inline-flex;
            align-items: center;
            margin: 5px;
            padding: 5px 10px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        .selected-option span {
            margin-right: 10px;
        }
        .selected-option button {
            background-color: transparent;
            color: red;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            padding: 0;
            margin-left: 5px;
        }
        .image-container {
            position: relative;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .image-container img {
            width: 100%;
            height: auto;
        }
        .danger-button {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="../firebase-config.js"></script> <!-- Include the config file -->
</head> 
<body class="container py-5">
    <button id="back-button" class="btn btn-secondary mt-2">Back to Dashboard</button>
    <h2 class="my-4">Hotel Details</h2>
    <form id="hotel-details-form">
        <div class="container-fluid">
            <div class="border shadow-sm rounded-3 p-3">
                <div class="rounded bg-white mb-2">
                    <div class="text-center mt-2">
                        <input type="file" id="hotelImages" accept="image/*" multiple>
                    </div>
                    <div class="row mt-3" id="hotelImagesPreview"></div>
                    <div class="row justify-content-center d-flex align-items-center">
                        <div class="col-md-12">
                            <div class="p-1 py-1">
                                <div class="row mt-2 d-flex align-items-center justify-content-center">
                                    <div class="col-lg-5"><label class="labels"><b>Hotel Name</b></label><input type="text" class="form-control" id="hotelName" placeholder="Hotel Name" required></div>
                                    <div class="col-lg-5"><label class="labels"><b>Hotel Address</b></label><input type="text" class="form-control" id="hotelAddress" placeholder="Hotel Address" required></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row justify-content-center d-flex align-items-center">
                        <div class="col-md-12">
                            <div class="p-1 py-1">
                                <div class="row mt-2 d-flex align-items-center justify-content-center">
                                    <div class="col-lg-5"><label class="labels"><b>Number of Rooms</b></label><input type="number" class="form-control" id="numRooms" placeholder="Number of Rooms" required></div>
                                    <div class="col-lg-5"><label class="labels"><b>Room Price</b></label><input type="number" class="form-control" id="roomPrice" placeholder="Room Price" required></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row justify-content-center d-flex align-items-center">
                        <div class="col-md-12">
                            <div class="p-1 py-1">
                                <div class="row mt-2 d-flex align-items-center justify-content-center">
                                    <div class="col-lg-5">
                                        <label class="labels"><b>Choose options</b></label>
                                        <select id="options" class="form-control">
                                            <option value="" disabled selected>Select your options</option>
                                            <option value="WiFi">WiFi</option>
                                            <option value="Food">Food</option>
                                            <option value="Parking">Parking</option>
                                            <option value="AC">AC</option>
                                            <option value="Water Heater">Water Heater</option>
                                            <option value="Restaurant">Restaurant</option>
                                        </select>
                                        <div id="selected-container" class="d-flex flex-wrap mb-3"></div>
                                    </div>
                                    <div class="col-lg-5 mt-4"><label class="labels">&nbsp;</label><button style="background-color: #ff1717; color: #fff;" class="btn profile-button" type="submit">Save</button></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <script>
        // Handle select options
        const selectElement = document.getElementById('options');
        const selectedContainer = document.getElementById('selected-container');
        const selectedOptions = new Set();

        selectElement.addEventListener('change', (event) => {
            const selectedValue = event.target.value;
            if (selectedValue && !selectedOptions.has(selectedValue)) {
                selectedOptions.add(selectedValue);
                updateSelectedContainer();
            }
        });

        function updateSelectedContainer() {
            selectedContainer.innerHTML = '';
            selectedOptions.forEach(option => {
                const selectedOption = document.createElement('div');
                selectedOption.className = 'selected-option';
                selectedOption.innerHTML = `
                    <span>${option}</span>
                    <button type="button" onclick="removeSelectedOption('${option}')">&times;</button>
                `;
                selectedContainer.appendChild(selectedOption);
            });
        }

        window.removeSelectedOption = function(option) {
            selectedOptions.delete(option);
            updateSelectedContainer();
        };

        // Load hotel details
        function loadHotelDetails(user) {
            db.collection('hotels').doc(user.uid).get().then((doc) => {
                if (doc.exists) {
                    const hotelData = doc.data();
                    document.getElementById('hotelName').value = hotelData.hotelName || "Sample Hotel Name";
                    document.getElementById('hotelAddress').value = hotelData.hotelAddress || "Sample Hotel Address";
                    document.getElementById('roomPrice').value = hotelData.roomPrice || 100;
                    document.getElementById('numRooms').value = hotelData.numRooms || 10;

                    const imagePreviewContainer = document.getElementById('hotelImagesPreview');
                    imagePreviewContainer.innerHTML = '';

                    // Display existing hotel images in grid
                    if (hotelData.hotelImages && hotelData.hotelImages.length > 0) {
                        hotelData.hotelImages.forEach((imageURL, index) => {
                            const colDiv = document.createElement('div');
                            colDiv.className = 'col-md-2';

                            const imageContainer = document.createElement('div');
                            imageContainer.className = 'image-container';
                            const image = document.createElement('img');
                            image.src = imageURL;
                            image.alt = 'Hotel Image';
                            image.className = 'img-thumbnail';
                            image.style.width = '100%';
                            image.style.height = 'auto';
                            imageContainer.appendChild(image);

                            const deleteButton = document.createElement('a');
                            deleteButton.href = '#';
                            deleteButton.className = 'btn btn-danger danger-button';
                            deleteButton.innerText = 'Delete';
                            deleteButton.onclick = function() {
                                deleteImage(user, index);
                                return false; // Prevent default link behavior
                            };

                            imageContainer.appendChild(deleteButton);
                            colDiv.appendChild(imageContainer);
                            imagePreviewContainer.appendChild(colDiv);
                        });
                    }

                    // Load amenities (renamed to accommodation details)
                    if (hotelData.accommodationDetails && hotelData.accommodationDetails.length > 0) {
                        hotelData.accommodationDetails.forEach(detail => {
                            selectedOptions.add(detail);
                        });
                        updateSelectedContainer();
                    }
                } else {
                    // Fill with default sample text if no hotel data exists
                    document.getElementById('hotelName').value = "Sample Hotel Name";
                    document.getElementById('hotelAddress').value = "Sample Hotel Address";
                    document.getElementById('roomPrice').value = 100;
                    document.getElementById('numRooms').value = 10;
                }
            }).catch((error) => {
                console.log("Error getting hotel details: ", error);
            });
        }

        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                loadHotelDetails(user);

                // Add event listener to form submission
                document.getElementById('hotel-details-form').addEventListener('submit', (event) => {
                    event.preventDefault();
                    const hotelName = document.getElementById('hotelName').value;
                    const hotelAddress = document.getElementById('hotelAddress').value;
                    const numRooms = document.getElementById('numRooms').value;
                    const roomPrice = document.getElementById('roomPrice').value;

                    db.collection('hotels').doc(user.uid).set({
                        hotelName: hotelName,
                        hotelAddress: hotelAddress,
                        numRooms: numRooms,
                        roomPrice: roomPrice,
                        accommodationDetails: Array.from(selectedOptions)
                    }, { merge: true }).then(() => {
                        console.log("Hotel details saved successfully!");
                        alert("Hotel details saved successfully!");
                        uploadHotelImages(user);
                    }).catch((error) => {
                        console.log("Error saving hotel details: ", error);
                        alert("Error saving hotel details: " + error.message);
                    });
                });
            } else {
                console.log("User is not signed in");
            }
        });

        // Upload hotel images to Firebase Storage
        function uploadHotelImages(user) {
            const fileInput = document.getElementById('hotelImages');
            const files = fileInput.files;
            const imageUrls = [];
            let uploadPromises = [];

            if (files.length > 0) {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const storageRef = firebase.storage().ref();
                    const fileRef = storageRef.child(`hotelImages/${user.uid}/${file.name}`);

                    const uploadTask = fileRef.put(file);
                    uploadPromises.push(
                        uploadTask.then(() => {
                            return fileRef.getDownloadURL().then((url) => {
                                imageUrls.push(url);
                            });
                        })
                    );
                }

                Promise.all(uploadPromises).then(() => {
                    db.collection('hotels').doc(user.uid).update({
                        hotelImages: firebase.firestore.FieldValue.arrayUnion(...imageUrls)
                    }).then(() => {
                        console.log("Images uploaded and URLs saved to Firestore successfully!");
                        alert("Images uploaded and URLs saved successfully!");
                        loadHotelDetails(user); // Refresh the hotel details after saving
                    }).catch((error) => {
                        console.log("Error updating image URLs: ", error);
                        alert("Error updating image URLs: " + error.message);
                    });
                }).catch((error) => {
                    console.log("Error uploading images: ", error);
                    alert("Error uploading images: " + error.message);
                });
            }
        }

        // Delete image from Firebase Storage
        function deleteImage(user, index) {
            db.collection('hotels').doc(user.uid).get().then((doc) => {
                if (doc.exists) {
                    const hotelData = doc.data();
                    const imageUrlToDelete = hotelData.hotelImages[index];

                    if (imageUrlToDelete) {
                        const storageRef = firebase.storage().refFromURL(imageUrlToDelete);
                        storageRef.delete().then(() => {
                            console.log("Image deleted from Firebase Storage");

                            const updatedHotelImages = hotelData.hotelImages.filter((_, i) => i !== index);
                            db.collection('hotels').doc(user.uid).update({
                                hotelImages: updatedHotelImages
                            }).then(() => {
                                console.log("Image URL removed from Firestore");
                                alert("Image deleted successfully!");
                                loadHotelDetails(user); // Refresh the hotel details after deletion
                            }).catch((error) => {
                                console.log("Error removing image URL from Firestore: ", error);
                                alert("Error removing image URL: " + error.message);
                            });
                        }).catch((error) => {
                            console.log("Error deleting image from Firebase Storage: ", error);
                            alert("Error deleting image: " + error.message);
                        });
                    }
                }
            }).catch((error) => {
                console.log("Error getting hotel details: ", error);
                alert("Error getting hotel details: " + error.message);
            });
        }

        // Back button click event
        document.getElementById('back-button').addEventListener('click', () => {
            window.location.href = 'dashboard.html';
        });
    </script>
</body>
</html>
<form id="hotel-details-form">
    <div class="container-fluid">
        <div class="border shadow-sm rounded-3 p-3">
            <div class="rounded bg-white mb-2">
                <div class="text-center mt-2">
                    <input type="file" id="hotelImages" accept="image/*" multiple>
                </div>
                <div class="container row mt-3 d-flex align-items-center justify-content-evenly" id="hotelImagesPreview"></div>
                <div class="row justify-content-center d-flex align-items-center">
                    <div class="col-md-12">
                        <div class="p-1 py-1">
                            <div class="row mt-2 d-flex align-items-center justify-content-center">
                                <div class="col-lg-5"><label class="labels"><b>Hotel Name</b></label><input type="text" class="form-control" id="hotelName" placeholder="Hotel Name" required></div>
                                <div class="col-lg-5"><label class="labels"><b>Hotel Address</b></label><input type="text" class="form-control" id="hotelAddress" placeholder="Hotel Address" required></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row justify-content-center d-flex align-items-center">
                    <div class="col-md-12">
                        <div class="p-1 py-1">
                            <div class="row mt-2 d-flex align-items-center justify-content-center">
                                <div class="col-lg-5"><label class="labels"><b>Number of Rooms</b></label><input type="number" class="form-control" id="numRooms" placeholder="Number of Rooms" required></div>
                                <div class="col-lg-5"><label class="labels"><b>Room Price</b></label><input type="number" class="form-control" id="roomPrice" placeholder="Room Price" required></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row justify-content-center d-flex align-items-center">
                    <div class="col-md-12">
                        <div class="p-1 py-1">
                            <div class="row mt-2 d-flex align-items-center justify-content-center">
                                <div class="col-lg-5">
                                    <label class="labels"><b>Add accommodation facilities</b></label>
                                    <select id="options" class="form-control">
                                        <option value="" disabled selected>Select your options</option>
                                        <option value="WiFi">WiFi</option>
                                        <option value="Food">Food</option>
                                        <option value="Parking">Parking</option>
                                        <option value="AC">AC</option>
                                        <option value="Water Heater">Water Heater</option>
                                        <option value="Restaurant">Restaurant</option>
                                    </select>
                                    <div id="selected-container" class="d-flex flex-wrap mb-3"></div>
                                </div>
                                <div class="col-lg-5 mt-4"><label class="labels">&nbsp;</label><button style="background-color: #ff1717; color: #fff;" class="btn profile-button" type="submit">Save</button></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>