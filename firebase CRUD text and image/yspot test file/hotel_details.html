<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hotel Details</title>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .image-container {
      position: relative;
      margin-bottom: 20px;
      overflow: hidden;
    }
    .image-container img {
      width: 100%;
      height: auto;
    }
    .danger-button {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 10;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
</head>
<body>
  <div class="container">
    <button id="back-button" class="btn btn-secondary mt-2">Back to Dashboard</button>
    <h2 class="my-4">Hotel Details</h2>
    <form id="hotel-details-form">
      <div class="form-group">
        <label for="hotelName">Hotel Name:</label>
        <input type="text" class="form-control" id="hotelName" required>
      </div>
      <div class="form-group">
        <label for="hotelAddress">Hotel Address:</label>
        <input type="text" class="form-control" id="hotelAddress" required>
      </div>
      <div class="form-group">
        <label for="roomPrice">Room Price:</label>
        <input type="number" class="form-control" id="roomPrice" required>
      </div>
      <div class="form-group">
        <label for="numRooms">Number of Rooms:</label>
        <input type="number" class="form-control" id="numRooms" required>
      </div>
      <div class="form-group">
        <label for="hotelImages">Hotel Images:</label>
        <input type="file" class="form-control-file" id="hotelImages" accept="image/*" multiple>
      </div>
      <button type="submit" class="btn btn-primary">Save</button>
      <div class="row mt-3" id="hotelImagesPreview"></div>
    </form>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCkTgEb7H_wNIgVhWwm-l-IzrHXDSe3ni4",
      authDomain: "testcrud-103a3.firebaseapp.com",
      databaseURL: "https://testcrud-103a3-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "testcrud-103a3",
      storageBucket: "testcrud-103a3.appspot.com",
      messagingSenderId: "387302339276",
      appId: "1:387302339276:web:e6c88525a1d80f9d154869",
      measurementId: "G-ZR3EB3CD3Z"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    function loadHotelDetails(user) {
      // Retrieve hotel details from Firestore
      db.collection('hotels').doc(user.uid).get().then((doc) => {
        if (doc.exists) {
          const hotelData = doc.data();
          document.getElementById('hotelName').value = hotelData.hotelName || "Sample Hotel Name";
          document.getElementById('hotelAddress').value = hotelData.hotelAddress || "Sample Hotel Address";
          document.getElementById('roomPrice').value = hotelData.roomPrice || 100;
          document.getElementById('numRooms').value = hotelData.numRooms || 10;

          const imagePreviewContainer = document.getElementById('hotelImagesPreview');
          imagePreviewContainer.innerHTML = '';

          // Display existing hotel images in grid
          if (hotelData.hotelImages && hotelData.hotelImages.length > 0) {
            hotelData.hotelImages.forEach((imageURL, index) => {
              const colDiv = document.createElement('div');
              colDiv.className = 'col-md-2';

              const imageContainer = document.createElement('div');
              imageContainer.className = 'image-container';
              const image = document.createElement('img');
              image.src = imageURL;
              image.alt = 'Hotel Image';
              image.className = 'img-thumbnail';
              image.style.width = '100%';
              image.style.height = 'auto';
              imageContainer.appendChild(image);

              const deleteButton = document.createElement('a');
              deleteButton.href = '#';
              deleteButton.className = 'btn btn-danger danger-button';
              deleteButton.innerText = 'Delete';
              deleteButton.onclick = function() {
                deleteImage(index);
                return false; // Prevent default link behavior
              };

              imageContainer.appendChild(deleteButton);
              colDiv.appendChild(imageContainer);
              imagePreviewContainer.appendChild(colDiv);
            });
          }
        } else {
          // Fill with default sample text if no hotel data exists
          document.getElementById('hotelName').value = "Sample Hotel Name";
          document.getElementById('hotelAddress').value = "Sample Hotel Address";
          document.getElementById('roomPrice').value = 100;
          document.getElementById('numRooms').value = 10;
        }
      }).catch((error) => {
        console.log('Error getting document:', error);
      });
    }

    // Redirect to login if not authenticated
    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        loadHotelDetails(user);
      } else {
        window.location.href = 'login.html';
      }
    });

    document.getElementById('hotel-details-form').addEventListener('submit', function(event) {
      event.preventDefault();

      const hotelName = document.getElementById('hotelName').value;
      const hotelAddress = document.getElementById('hotelAddress').value;
      const roomPrice = document.getElementById('roomPrice').value;
      const numRooms = document.getElementById('numRooms').value;
      const user = firebase.auth().currentUser;

      let hotelImagesUrls = [];
      const hotelImagesFiles = document.getElementById('hotelImages').files;
      if (hotelImagesFiles.length > 0) {
        db.collection('hotels').doc(user.uid).get().then((doc) => {
          const hotelData = doc.data();
          const existingImages = hotelData.hotelImages || [];
          const promises = [];
          for (let i = 0; i < hotelImagesFiles.length; i++) {
            const storageRef = storage.ref(`HotelImages/${user.uid}/hotelImage${existingImages.length + i}.jpg`);
            const uploadTask = storageRef.put(hotelImagesFiles[i]);
            promises.push(uploadTask.then(() => storageRef.getDownloadURL()));
          }
          Promise.all(promises).then((urls) => {
            hotelImagesUrls = [...existingImages, ...urls];
            saveHotelDetails(user, hotelName, hotelAddress, roomPrice, numRooms, hotelImagesUrls);
          }).catch((error) => {
            console.error('Error uploading hotel images: ', error);
          });
        }).catch((error) => {
          console.error('Error getting hotel data: ', error);
        });
      } else {
        saveHotelDetails(user, hotelName, hotelAddress, roomPrice, numRooms, hotelImagesUrls);
      }
    });

    function saveHotelDetails(user, hotelName, hotelAddress, roomPrice, numRooms, hotelImagesUrls) {
      db.collection('hotels').doc(user.uid).set({
        hotelName: hotelName,
        hotelAddress: hotelAddress,
        roomPrice: roomPrice,
        numRooms: numRooms,
        hotelImages: hotelImagesUrls,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        alert('Hotel details updated successfully!');
        loadHotelDetails(user); // Reload the content after saving
        window.location.href = 'hotel_details.html';
      }).catch((error) => {
        console.error('Error writing hotel document: ', error);
      });
    }

    function deleteImage(index) {
      const user = firebase.auth().currentUser;
      db.collection('hotels').doc(user.uid).get().then((doc) => {
        if (doc.exists) {
          const hotelData = doc.data();
          const imageUrl = hotelData.hotelImages[index];
          if (imageUrl) {
            // Delete from storage
            const imageRef = storage.refFromURL(imageUrl);
            imageRef.delete().then(() => {
              // Remove from Firestore array
              hotelData.hotelImages.splice(index, 1);
              db.collection('hotels').doc(user.uid).set(hotelData).then(() => {
                alert('Image deleted successfully!');
                loadHotelDetails(user); // Reload the content after deleting
              }).catch((error) => {
                console.error('Error updating hotel document: ', error);
              });
            }).catch((error) => {
              console.error('Error deleting image: ', error);
            });
          }
        }
      }).catch((error) => {
        console.error('Error getting document:', error);
      });
    }

    document.getElementById('back-button').addEventListener('click', function() {
      window.location.href = 'admin_dashboard.html';
    });
  </script>
</body>
</html>
